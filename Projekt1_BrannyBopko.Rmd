---
title: "Mini_projekt1"
output: html_notebookä
owner: "Bopkó M., Branný D."
---


Tento projekt je zameraný na predspracvoanie, analýzu dát a vytvorení modelu o predikovaní Infarktu. ( https://www.kaggle.com/datasets/m1relly/heart-attack-prediction ) . 
Cieľ je dáta predspracovať podľa potrebny a vytvoriť modely lineárnej a logistickej regresie. 

## Heart Attack Prediction Dataset

Dáta pre predikciu srdcových infarktov zahŕňajú rôzne klinické a medicínske merania ale aj atribúty opisujúce geografickú polohu pacienta a životný štýl. Tu je stručný zoznam atribútov:

1. **`Patient ID`**: Identifikačné číslo pacienta.
2. **`Age`**: Vek pacienta.
3. **`Sex`**: Pohlavie pacienta.
4. **`Cholesterol`**: Hladina cholesterolu v krvi.
5. **`Blood Pressure`**: Krvný tlak, zaznamenaný ako systolický/diastolický.
6. **`Heart Rate`**: Srdcová frekvencia v tepoch za minútu.
7. **`Diabetes`**: Indikátor prítomnosti diabetu (0 = nie, 1 = áno).
8. **`Family History`**: Rodinná anamnéza srdcových ochorení (0 = nie, 1 = áno).
9. **`Smoking`**: Fajčenie (0 = nie, 1 = áno).
10. **`Obesity`**: Obezita (0 = nie, 1 = áno).
11. **`Alcohol Consumption`**: Príjem alkoholu.
12. **`Exercise Hours Per Week`**: 
13. **`Diet`**: Popis diéty. 
14. **`Previous Heart Problems`**: Či boli zaznamenané problémy so srdcom. 
15. **`Medication use`**: 
16. **`Stress level`**
17. **`Sedentary hours per day`**
18. **`Income`**:
19. **`BMI`**
20. **`Triglycerides`**
21. **`Physical Activity Days Per Week`**: Rozloženie fyzickej aktivity do dní v týždni
22. **`Sleep Hours Per Day`**: Počet hodín spánku / deň
23. **`Country`**: Krajina
24. **`Continent`**: Kontinent
25. **`Hemisphere`**: Severná či južná pologuľa
26. **`Heart Attack Risk`**: Riziko infarktu (0 = nie, 1 = áno).


Načítanie potrebných knižníc pre projekt ako sú tidyverse, magrittr, data.table, caret, ggplot2, a readxl.

```{r}
library(tidyverse)
library(magrittr) 
library(data.table) 
library(caret)
library(ggplot2)
library(readxl)
library(cowplot)
```

Nastavenie pracovnho adresára a vylistovanie súborov v ňom.

```{r}
setwd("C:/Users/David/Desktop/skola/ING/4.semester/OZNAL/Projekt/OZNAL-Submission1-Regression-Classification") 
list.files() 
```

Načítanie csv datasetov.

```{r}
data <- read.csv("heart_attack_prediction_dataset.csv")
names(data)
head(data)
```
Opis datasetu cez summary()

```{r}
summary(data)
```


```{r}

number_of_uniq_data <- sapply(data, function(x) length(unique(x)))
cat("Unique values in dataset:\n")
print(number_of_uniq_data)


```
Vidíme, že ako sme prepodkladali, dáta ktoré sa podľa názvu zdali byť binárne reálne disponujú dvomi hodnotami,, teda nemusíme sa zaoberať týmto problémom dalej. 


Vykreslíme si grafy, ktoré nám povedia o rozložení v danom stĺpci.

```{r}

numeric_columns <- sapply(data, is.numeric)  # Identify numeric columns
non_binary_numeric_columns <- numeric_columns & !apply(data, 2, function(x) all(x %in% c(0, 1)))
non_bin_names <- names(non_binary_numeric_columns[non_binary_numeric_columns])

print_histograms <- function(data, columns) {
  for (col_name in columns) {
    p <- ggplot(data, aes_string(x = col_name)) +
      geom_histogram(bins = 30, fill = "skyblue", color = "black") +
      theme_minimal() +
      ggtitle(paste("Distribution of", col_name)) +
      xlab(col_name) +
      ylab("Count")
    print(p)
  }
}

print_histograms(data, non_bin_names)
```

Boxploty pre každý nebinárny stĺpec


```{r}
for (col_name in non_bin_names){
  p <- ggplot(data, aes_string(y = col_name)) + 
      geom_boxplot(fill = "lightgrey") +
      ggtitle(paste("Distribution of", col_name)) + 
      ylab(col_name) + xlab("")
  print(p)
}

```


```{r}
handle_outliers <- function(data, columns, sensitivity) {
  na_counts <- setNames(numeric(length(columns)), columns)  # Initialize a vector to hold NA counts for each column
  
  for (col in columns) {
    # Count NAs before handling outliers
    na_count_before <- sum(is.na(data[[col]]))
    
    # Calculate quartiles and IQR
    q1 <- quantile(data[[col]], 0.25, na.rm = TRUE)
    q3 <- quantile(data[[col]], 0.75, na.rm = TRUE)
    iqr <- q3 - q1
    
    # Define upper and lower bounds for outliers
    upper_bound <- q3 + iqr*sensitivity
    lower_bound <- q1 - iqr*sensitivity
    
    print(paste("Upper bound for", col, ":", upper_bound))
    print(paste("Lower bound for", col, ":", lower_bound))
    # Replace outliers with NA
    data[[col]] <- ifelse(data[[col]] < lower_bound | data[[col]] > upper_bound, NA, data[[col]])
    
    # Count NAs after handling outliers
    na_count_after <- sum(is.na(data[[col]]))
    
    # Calculate the number of NAs added
    na_counts[col] <- na_count_after - na_count_before
    
    # Print the number of NAs added for the current column
    cat("NAs added in", col, ":", na_counts[col], "\n")
    data <- na.omit(data)
  }
  
  # Return the cleaned data and the NA counts
  return(data)
}
View(data)
interesting_columns <- c("BMI", "Cholesterol")
# Apply the function to your dataset
cat("The dataset has", dim(data)[1], "rows and", dim(data)[2], "columns\n")

data <- handle_outliers(data, interesting_columns, 0.5)
cat("The dataset has", dim(data)[1], "rows and", dim(data)[2], "columns\n")




```


Prejdeme na samotnú prípravu stĺpcov na modely. Najskôr vytvoríme dva stĺpce. Tie vzniknú "rozdelením" Blood Pressure stĺpca a teda vytvoríme Systolic a Diastolic stĺpce. 

```{r}
 data %<>%
  mutate( 
         Systolic = as.numeric(sapply(strsplit(Blood.Pressure, "/"), `[`, 1)),
         Diastolic = as.numeric(sapply(strsplit(Blood.Pressure, "/"), `[`, 2))) %>%
  relocate(Systolic, Diastolic, .after = Blood.Pressure)

head(data)
```

Vzhľadom na to, že vo väčšine prípadov ľudia nevedia odhadnúť svoju fyzickú aktivitu alebo sedavý čas s takou presnosťou ako je v datasete ( 5/8 desatinnych miest). Tak si tieto hodnoty zaokrúhlime na dve desatinné miesta. 

```{r}
data$Exercise.Hours.Per.Week <- round(data$Exercise.Hours.Per.Week, 2)
data$Sedentary.Hours.Per.Day <- round(data$Sedentary.Hours.Per.Day, 2)
data %>% 
  select(Exercise.Hours.Per.Week, Sedentary.Hours.Per.Day) %>%
  head()
```

Zakódovanie hodnôt Diet a Sex do numeric

```{r}
data %<>%
  mutate(
    Diet_code = case_when(
      data$Diet == "Average" ~ 1,
      data$Diet == "Unhealthy" ~ 2,
      data$Diet == "Healthy" ~ 0))  %>%
  relocate(Diet_code, .before = Diet)

data %<>%
  mutate(
    Sex_code = case_when(
      data$Sex == "Male" ~ 0,
      data$Sex == "Female" ~ 1))  %>%
  relocate(Sex_code, .after = Sex)


data %<>%
  mutate(
    Pensioner = case_when(
      data$Age > 67 ~ 1,
      .default = 0))  %>%
  relocate(Pensioner, .after = Age)

head(data)

```




```{r}
#-----Helper functions-----
panel.cor <- function(x,y, digits=2, prefix="", cex.cor){
  usr <- par("usr")
  on.exit(par(usr))
  par(usr = c(0,1,0,1))
  r <- abs(cor(x,y,use="complete.obs"))
  txt <- format(c(r,0.123456789), digits = digits)[1]
  txt <- paste0(prefix, txt,sep="")
  if(missing(cex.cor)) cex.cor <- 0.8/strwidth(txt)
  text(0.5, 0.5, txt, cex = cex.cor * (1 + r) / 2)
}

panel.hist <- function(x, ...){
  usr <- par("usr")
  on.exit(par(usr))
  par(usr = c(usr[1:2],0,1.5))
  h <- hist(x, plot = FALSE)
  breaks <- h$breaks
  nB <- length(breaks)
  y <- h$counts
  y <- y/max(y)
  rect(breaks[-nB], 0, breaks[-1], y, col="white",...)
}

panel.lm <- function(x,y,col = par("col"), bg = NA, pch = par("pch"),
                     cex = 1, col.smooth = "blue",...){
  points(x,y,pch=pch, col=col(alpha = 0.1), bg=bg, cex=cex)
  abline(stats::lm(x ~ y), col = "steelblue", ...)
} 
```




```{r}
data %>%
  dplyr::filter() %$%
  pairs( ~ BMI + Exercise.Hours.Per.Week + Diet_code + Cholesterol + Sedentary.Hours.Per.Day ,    
         upper.panel= NULL, 
         diag.panel=panel.hist,
         lower.panel=panel.smooth)
```

```{r}
correlation_matrix <- cor(data[, c('BMI', 'Exercise.Hours.Per.Week', 'Diet_code', 'Cholesterol', 'Sedentary.Hours.Per.Day', 'Heart.Rate')])
print(correlation_matrix)

# Create a dataframe from the correlation matrix
correlation_df <- as.data.frame(correlation_matrix)
correlation_df$row <- rownames(correlation_matrix)

# Melt the dataframe to long format
correlation_df_long <- reshape2::melt(correlation_df, id.vars = "row")

# Plot heatmap
ggplot(correlation_df_long, aes(x = row, y = variable, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0, limit = c(-1, 1), space = "Lab", name = "Correlation") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

```
Vidíme pozitívne aj negatívne korelácie, na logistickú regresiu budeme predikovať Heart.Attack.Risk, na predikovanie hladiny cholesterolu v krvi budeme používať predikáty ako BMI a Diet.code ( ktorý je nastavený tak, že čím nezdravšia strava tým vyššia hodnota) teda všetky očakávane pozitívne korelácie.


Vo vzťahu k hladine Cholesterolu si teda vyplotujeme nasledujúce ploty. Tie ukázali, že asi potrebujeme do modelu viacero predikátov a teda použijeme aj Age všetky predikáty okrem Sleep.Hours.Per.Day.



```{r}

p1 <- data %>%
  filter(Sex_code == 1) %>%
  ggplot(., aes(x = BMI, y = Cholesterol)) + 
  geom_point(shape = 1, alpha=0.1, size = 2) + 
  stat_smooth(method="lm", se=TRUE, fill=NA,
              formula=y ~ poly(x, 1, raw=FALSE),colour="red", linewidth=0.3) +
  ggtitle("Ženy penzistky", subtitle = "") + 
  ylab("Cholesterol") + xlab("BMI") +
  scale_y_continuous(labels = scales::comma)+
  geom_rug(position = "jitter", size = 0.2)

p2 <- data %>%
  filter(Sex_code == 0) %>%
  ggplot(., aes(x = BMI, y = Cholesterol)) + 
  geom_point(shape = 1, alpha=0.1, size = 2) + 
  stat_smooth(method="lm", se=TRUE, fill=NA,
              formula=y ~ poly(x, 1, raw=FALSE),colour="red", linewidth=0.3) +
  ggtitle("Muži penzisti", subtitle = "") + 
  ylab("Cholesterol") + xlab("BMI") +
  scale_y_continuous(labels = scales::comma)+
  geom_rug(position = "jitter", size = 0.2)

p3 <- data %>%
  ggplot(., aes(x = factor(Sex_code), y = BMI)) + 
  geom_boxplot(fill = "lightgrey") +
  ggtitle("BMI") + 
  ylab("") + xlab("") +
  scale_x_discrete(labels = c("Ženy", "Muži"))

p4 <- data %>%
  ggplot(., aes(x = factor(Sex_code), y = Cholesterol)) + 
  geom_boxplot(fill = "lightgrey") +
  ggtitle("Cholesterol") + 
  ylab("") + xlab("") +
  scale_x_discrete(labels = c("Ženy", "Muži"))

plot_grid(p1, p2, p3, p4, ncol = 2, nrow = 2)
```
Vzhľadom na grafy, ktoré predstavujú rôzne premenné a ich vzťahy, sa zdá, že by sme mohli formulovať hypotézu týkajúcu sa faktorov ovplyvňujúcich hodnotu BMI. Grafy naznačujú, že existuje aký taký vzťah medzi Cholesterolom, stravovacími návykmi (Diet_code).
 

Cholesterol (H0): Zvýšenie hladiny cholesterolu nemá žiadny vplyv na hodnoty BMI jedincov. Teda, koeficient pre premennú cholesterol v modeli lineárnej regresie je rovný nule.

Diet_code (H0): Zmena v diétnom kóde nemá žiadny vplyv na hodnoty BMI jedincov. Koeficient pre premennú Diet_code v modeli lineárnej regresie je rovný nule.

## Lineárna Regresia

```{r}
model <- data %$% 
  lm(BMI ~ Cholesterol + Diet_code )

summary(model)
```
Na základe výstupu z lineárneho regresného modelu:

- Intercept: Priemerná hodnota BMI, keď sú všetky ostatné premenné nulové, je 28.37. Tento koeficient je štatisticky významný (p < 0.05).

- Cholesterol: Za každú jednotku zvýšenia cholesterolu sa BMI zvýši o 0.001837, čo je štatisticky významné (p < 0.05). Hoci je vplyv malý, je považovaný za štatisticky signifikantný.

- Diet_code: Tento koeficient ukazuje zmenu v BMI pre zmenu dietného kódu o jednu jednotku. Hodnota -0.0934183 nie je štatisticky významná (p > 0.05), čo naznačuje, že zmena diéty nemá významný vplyv na BMI. Dokonca ukazuje opačný ako očakávaný výsledok, kedže hodnoty v Diet.Code sú nastavené tak, že čím vyšia hodnota tým viac očakávame BMI.


Model má nízke R-squared hodnoty, čo naznačuje, že tieto premenné spoločne vysvetľujú len malú časť variability hladiny cholesterolu. Celkový F-test je štatisticky významný, čo naznačuje, že model ako celok má určitú predikčnú schopnosť, ale táto schopnosť je značne obmedzená :D .

Residual standard error: Priemerná odchýlka skutočných hodnôt BMI od hodnôt predpovedaných modelom je 6.245. Značí to o pomerne zlom prisôsobení modelu.
Multiple R-squared: Koeficient determinácie 0.0006899  hovorí, že model vysvetľuje len veľmi malé percento variability v BMI.
Adjusted R-squared: Upravený R-kvadrát 0.0004556 zohľadňuje počet prediktorov v modeli a ponúka realistický pohľad na vysvetľujúcu silu modelu, ktorá je stále veľmi nízka.

Celkovo tieto štatistiky naznačujú, že model nevysvetľuje skoro žiadnu variabilitu v závislej premennej a nemusí byť štatisticky významný na úrovni signifikancie 0.05. Mohlo by to naznačovať potrebu prehodnotiť dáta, alebo skúsiť iný modelovací prístup než lineárnu regresiu.


```{r}
par(mfrow = c(1,3)) # par() sets up a plotting grid: 1 row x 3 columns
plot(model, which = c(1,2,5))

nevideneData <- tibble(Cholesterol = 300, Sedentary.Hours.Per.Day = 4, Diet_code = 2)
predict(model, newdata = nevideneData)
```
Grafy naznačujú, že by ste mohli mať problém s niektorými predpokladmi lineárnej regresie. 



## Logistická Regresia (Binárna Klasifikácia)


